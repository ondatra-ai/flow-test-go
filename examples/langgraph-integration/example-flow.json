{
  "$schema": "https://flow-test-go/schemas/flow/v1.0.json",
  "version": "1.0",
  "id": "code-review-flow",
  "name": "Automated Code Review Flow",
  "description": "Reviews code changes and creates GitHub issues for problems",
  "variables": {
    "repository": "${GITHUB_REPO}",
    "branch": "${GITHUB_BRANCH:-main}",
    "model": "gpt-4"
  },
  "steps": {
    "fetch-changes": {
      "type": "prompt",
      "prompt": {
        "template": "Fetch the latest changes from {{variables.branch}} branch"
      },
      "tools": ["get_pull_request_diff", "list_files"],
      "mcpServer": "github-mcp",
      "next": "analyze-code"
    },
    "analyze-code": {
      "type": "prompt",
      "prompt": {
        "template": "Analyze the following code changes for potential issues:\n\n{{result.diff}}\n\nLook for:\n- Security vulnerabilities\n- Performance issues\n- Code style violations\n- Potential bugs"
      },
      "model": "{{variables.model}}",
      "tools": ["read_file", "search_code"],
      "mcpServer": "filesystem-mcp",
      "next": "check-issues"
    },
    "check-issues": {
      "type": "condition",
      "conditions": [
        {
          "expression": "result.issues.some(i => i.severity === 'critical')",
          "next": "create-urgent-issue"
        },
        {
          "expression": "result.issues.length > 0",
          "next": "create-issue"
        },
        {
          "expression": "true",
          "next": "approve-changes"
        }
      ]
    },
    "create-urgent-issue": {
      "type": "prompt",
      "prompt": {
        "template": "Create an urgent GitHub issue for critical problems found"
      },
      "tools": ["create_issue", "add_labels"],
      "mcpServer": "github-mcp",
      "next": "notify-team"
    },
    "create-issue": {
      "type": "prompt",
      "prompt": {
        "template": "Create a GitHub issue summarizing the problems found"
      },
      "tools": ["create_issue"],
      "mcpServer": "github-mcp",
      "next": "complete"
    },
    "approve-changes": {
      "type": "prompt",
      "prompt": {
        "template": "Add approval comment to the pull request"
      },
      "tools": ["add_comment"],
      "mcpServer": "github-mcp",
      "next": "complete"
    },
    "notify-team": {
      "type": "prompt",
      "prompt": {
        "template": "Send urgent notification about critical issues"
      },
      "next": "complete"
    },
    "complete": {
      "type": "end"
    }
  }
}
